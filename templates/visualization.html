{% extends 'layout.html'%}

{% block content %}
<style>
    /* Base Styles */
    :root {
        --primary-color: #6c63ff;
        --secondary-color: #4e73df;
        --accent-color: #ffb300;
        --success-color: #28a745;
        --info-color: #17a2b8;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --dark-color: #343a40;
        --light-color: #f8f9fa;
        --text-color: #212529;
        --text-muted: #6c757d;
        --border-color: #dee2e6;
        --card-bg: #ffffff;
        --card-shadow: 0 8px 24px rgba(31, 38, 135, 0.12);
        --hover-shadow: 0 12px 32px rgba(31, 38, 135, 0.18);
        --creator-color: #023020;
        --sponsor-color: #add8e6;
        --creator-industry-color: #00008B;
        --sponsor-industry-color: #dc143c;
        --max-color: #ffb300;
    }

    [data-theme="dark"] {
        --primary-color: #7c73ff;
        --secondary-color: #5e83df;
        --card-bg: #2d3748;
        --text-color: #e2e8f0;
        --text-muted: #a0aec0;
        --border-color: #4a5568;
        --card-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        --hover-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
    }

    /* Layout & Background */
    .dashboard-container {
        min-height: 100vh;
        background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
        padding: 2rem 0;
    }

    [data-theme="dark"] .dashboard-container {
        background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
    }

    .dashboard-wrapper {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 1rem;
    }

    /* Dashboard Header */
    .dashboard-header {
        margin-bottom: 2rem;
        text-align: center;
        position: relative;
    }

    .dashboard-title {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 1rem;
        background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        position: relative;
        display: inline-block;
    }

    .dashboard-subtitle {
        font-size: 1.2rem;
        color: var(--text-muted);
        max-width: 700px;
        margin: 0 auto 1.5rem;
    }

    /* Control Panel */
    .control-panel {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
        animation: slideDown 0.5s ease;
    }

    .control-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .control-panel-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-color);
        display: flex;
        align-items: center;
    }

    .control-panel-title i {
        margin-right: 0.5rem;
        color: var(--primary-color);
    }

    .control-panel-body {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .control-group {
        flex: 1;
        min-width: 200px;
    }

    .control-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text-color);
    }

    .control-select {
        width: 100%;
        padding: 0.5rem;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background-color: var(--card-bg);
        color: var(--text-color);
        transition: all 0.2s ease;
    }

    .control-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(108, 99, 255, 0.25);
    }

    /* Dashboard Grid */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .grid-col-12 {
        grid-column: span 12;
    }

    .grid-col-8 {
        grid-column: span 8;
    }

    .grid-col-4 {
        grid-column: span 4;
    }

    @media (max-width: 992px) {
        .grid-col-8, .grid-col-4 {
            grid-column: span 12;
        }
    }

    /* Cards */
    .dashboard-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--card-shadow);
        overflow: hidden;
        transition: all 0.3s ease;
        height: 100%;
        position: relative;
    }

    .dashboard-card:hover {
        box-shadow: var(--hover-shadow);
        transform: translateY(-5px);
    }

    .card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-title {
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0;
        color: var(--text-color);
        display: flex;
        align-items: center;
    }

    .card-title i {
        margin-right: 0.75rem;
        color: var(--primary-color);
    }

    .card-actions {
        display: flex;
        gap: 0.5rem;
    }

    .card-action-btn {
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 1rem;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .card-action-btn:hover {
        color: var(--primary-color);
        background-color: rgba(108, 99, 255, 0.1);
    }

    .card-body {
        padding: 1.5rem;
        position: relative;
    }

    /* Graph Containers */
    .graph-container {
        width: 100%;
        height: 500px;
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        background: rgba(240, 240, 255, 0.1);
        transition: all 0.3s ease;
    }

    .graph-container.loading::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.7);
        z-index: 10;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    [data-theme="dark"] .graph-container.loading::before {
        background: rgba(45, 55, 72, 0.7);
    }

    .graph-container.loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        border: 5px solid var(--border-color);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        z-index: 11;
    }

    @keyframes spin {
        to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* Legend */
    .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin: 1rem 0;
        justify-content: center;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-color);
        padding: 0.5rem 0.75rem;
        border-radius: 50px;
        background-color: rgba(240, 240, 255, 0.5);
        transition: all 0.2s ease;
    }

    [data-theme="dark"] .legend-item {
        background-color: rgba(45, 55, 72, 0.5);
    }

    .legend-item:hover {
        background-color: rgba(108, 99, 255, 0.1);
    }

    .legend-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: inline-block;
        border: 2px solid var(--card-bg);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .legend-dot.creator { background: var(--creator-color); }
    .legend-dot.sponsor { background: var(--sponsor-color); }
    .legend-dot.creator_industry { background: var(--creator-industry-color); }
    .legend-dot.sponsor_industry { background: var(--sponsor-industry-color); }
    .legend-dot.max { background: var(--max-color); }

    /* Tooltip */
    #graph-tooltip {
        position: fixed;
        pointer-events: none;
        background: rgba(30, 30, 40, 0.95);
        color: #fff;
        padding: 1rem;
        border-radius: 8px;
        font-size: 0.9rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        z-index: 9999;
        display: none;
        max-width: 300px;
        white-space: pre-line;
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transform: translate(10px, 10px);
        transition: opacity 0.2s ease;
    }

    .tooltip-title {
        font-weight: 700;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .tooltip-content {
        font-size: 0.85rem;
        line-height: 1.5;
    }

    .tooltip-label {
        font-weight: 600;
        color: rgba(255, 255, 255, 0.7);
    }

    /* Stats Cards */
    .stats-card {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .stats-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .stats-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-muted);
    }

    .stats-icon {
        font-size: 1.5rem;
        color: var(--primary-color);
        background-color: rgba(108, 99, 255, 0.1);
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
    }

    .stats-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-color);
        margin: 0.5rem 0;
    }

    .stats-description {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-top: auto;
    }

    .stats-trend {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
        font-size: 0.9rem;
    }

    .stats-trend.up {
        color: var(--success-color);
    }

    .stats-trend.down {
        color: var(--danger-color);
    }

    /* Data Assistant */
    .data-assistant {
        padding: 1.5rem;
    }

    .assistant-header {
        margin-bottom: 1.5rem;
    }

    .assistant-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-color);
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .assistant-title i {
        margin-right: 0.75rem;
        color: var(--primary-color);
    }

    .assistant-description {
        font-size: 0.9rem;
        color: var(--text-muted);
    }

    .question-form {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .question-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--card-bg);
        color: var(--text-color);
        font-size: 1rem;
        transition: all 0.2s ease;
    }

    .question-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(108, 99, 255, 0.25);
    }

    .question-submit {
        padding: 0.75rem 1.25rem;
        border-radius: 8px;
        background-color: var(--primary-color);
        color: white;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .question-submit:hover {
        background-color: var(--secondary-color);
    }

    .question-submit.loading {
        opacity: 0.7;
        pointer-events: none;
    }

    .question-submit.loading .submit-icon {
        animation: spin 1s linear infinite;
    }

    .answer-container {
        background-color: rgba(240, 240, 255, 0.2);
        border-radius: 8px;
        padding: 1.25rem;
        min-height: 100px;
        position: relative;
    }

    [data-theme="dark"] .answer-container {
        background-color: rgba(45, 55, 72, 0.3);
    }

    .answer-placeholder {
        color: var(--text-muted);
        font-style: italic;
    }

    .answer-content {
        color: var(--text-color);
        line-height: 1.6;
    }

    .answer-loading {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 8px;
        z-index: 5;
    }

    [data-theme="dark"] .answer-loading {
        background-color: rgba(45, 55, 72, 0.7);
    }

    .typing-indicator {
        display: flex;
        gap: 0.25rem;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: var(--primary-color);
        animation: typingAnimation 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingAnimation {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-6px); }
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .fade-in {
        animation: fadeIn 0.5s ease forwards;
    }

    .pulse {
        animation: pulse 2s infinite;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .dashboard-title {
            font-size: 2rem;
        }

        .dashboard-subtitle {
            font-size: 1rem;
        }

        .graph-container {
            height: 400px;
        }

        .control-panel-body {
            flex-direction: column;
        }

        .control-group {
            width: 100%;
        }

        .question-form {
            flex-direction: column;
        }

        .question-submit {
            width: 100%;
        }
    }

    @media (max-width: 576px) {
        .dashboard-wrapper {
            padding: 0 0.5rem;
        }

        .card-header {
            padding: 1rem;
        }

        .card-body {
            padding: 1rem;
        }

        .graph-container {
            height: 350px;
        }

        .legend {
            gap: 0.5rem;
        }

        .legend-item {
            font-size: 0.8rem;
            padding: 0.4rem 0.6rem;
        }
    }
</style>

<div class="dashboard-container">
    <div class="dashboard-wrapper">
        <!-- Dashboard Header -->
        <div class="dashboard-header fade-in">
            <h1 class="dashboard-title">Interactive Data Visualization</h1>
            <p class="dashboard-subtitle">Explore the relationships between creators, sponsors, and their industries with our interactive 3D visualization tools.</p>
        </div>

        <!-- Control Panel -->
        <div class="control-panel fade-in" style="animation-delay: 0.1s;">
            <div class="control-panel-header">
                <h2 class="control-panel-title"><i class="fas fa-sliders-h"></i> Visualization Controls</h2>
                <button id="theme-toggle-btn" class="card-action-btn" title="Toggle Dark/Light Mode">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
            <div class="control-panel-body">
                <div class="control-group">
                    <label for="visualization-type" class="control-label">Visualization Type</label>
                    <select id="visualization-type" class="control-select">
                        <option value="3d" selected>3D Force Graph</option>
                        <option value="2d">2D Network</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="node-size" class="control-label">Node Size</label>
                    <select id="node-size" class="control-select">
                        <option value="default" selected>Default</option>
                        <option value="connections">By Connections</option>
                        <option value="influence">By Influence</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="link-strength" class="control-label">Link Strength</label>
                    <select id="link-strength" class="control-select">
                        <option value="default" selected>Default</option>
                        <option value="weak">Weak</option>
                        <option value="strong">Strong</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="animation-speed" class="control-label">Animation Speed</label>
                    <select id="animation-speed" class="control-select">
                        <option value="slow">Slow</option>
                        <option value="default" selected>Default</option>
                        <option value="fast">Fast</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Creator & Sponsor Graph -->
            <div class="grid-col-8 fade-in" style="animation-delay: 0.2s;">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-project-diagram"></i> Creator & Sponsor Correlation</h3>
                        <div class="card-actions">
                            <button class="card-action-btn refresh-graph" data-graph="graph1" title="Refresh Graph">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="card-action-btn fullscreen-graph" data-graph="graph1" title="Fullscreen">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="legend">
                            <div class="legend-item"><span class="legend-dot creator"></span>Creator</div>
                            <div class="legend-item"><span class="legend-dot sponsor"></span>Sponsor</div>
                            <div class="legend-item"><span class="legend-dot max"></span>Most Collaborated</div>
                        </div>
                        <div id="graph1" class="graph-container loading"></div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid-col-4">
                <div class="dashboard-grid" style="gap: 1rem;">
                    <!-- Total Creators -->
                    <div class="grid-col-12 fade-in" style="animation-delay: 0.3s;">
                        <div class="dashboard-card">
                            <div class="stats-card">
                                <div class="stats-header">
                                    <div class="stats-title">Total Creators</div>
                                    <div class="stats-icon"><i class="fas fa-users"></i></div>
                                </div>
                                <div class="stats-value" id="total-creators">--</div>
                                <div class="stats-description">Number of unique creators in the dataset</div>
                                <div class="stats-trend up">
                                    <i class="fas fa-arrow-up"></i> <span id="creators-trend">--</span>% from last period
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Total Sponsors -->
                    <div class="grid-col-12 fade-in" style="animation-delay: 0.4s;">
                        <div class="dashboard-card">
                            <div class="stats-card">
                                <div class="stats-header">
                                    <div class="stats-title">Total Sponsors</div>
                                    <div class="stats-icon"><i class="fas fa-building"></i></div>
                                </div>
                                <div class="stats-value" id="total-sponsors">--</div>
                                <div class="stats-description">Number of unique sponsors in the dataset</div>
                                <div class="stats-trend up">
                                    <i class="fas fa-arrow-up"></i> <span id="sponsors-trend">--</span>% from last period
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top Collaboration -->
                    <div class="grid-col-12 fade-in" style="animation-delay: 0.5s;">
                        <div class="dashboard-card">
                            <div class="stats-card">
                                <div class="stats-header">
                                    <div class="stats-title">Top Collaboration</div>
                                    <div class="stats-icon"><i class="fas fa-handshake"></i></div>
                                </div>
                                <div class="stats-value" id="top-collaboration-count">--</div>
                                <div class="stats-description">
                                    <span id="top-collaboration-names">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Industry Graph -->
            <div class="grid-col-8 fade-in" style="animation-delay: 0.6s;">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-industry"></i> Industry Correlation</h3>
                        <div class="card-actions">
                            <button class="card-action-btn refresh-graph" data-graph="graph2" title="Refresh Graph">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="card-action-btn fullscreen-graph" data-graph="graph2" title="Fullscreen">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="legend">
                            <div class="legend-item"><span class="legend-dot creator_industry"></span>Creator Industry</div>
                            <div class="legend-item"><span class="legend-dot sponsor_industry"></span>Sponsor Industry</div>
                            <div class="legend-item"><span class="legend-dot max"></span>Most Collaborated</div>
                        </div>
                        <div id="graph2" class="graph-container loading"></div>
                    </div>
                </div>
            </div>

            <!-- Data Assistant -->
            <div class="grid-col-4 fade-in" style="animation-delay: 0.7s;">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-robot"></i> Data Assistant</h3>
                        <div class="card-actions">
                            <button class="card-action-btn" id="clear-chat" title="Clear Chat">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="data-assistant">
                        <div class="assistant-header">
                            <p class="assistant-description">Ask questions about the data to get insights and explanations.</p>
                        </div>
                        <form id="question-form" class="question-form">
                            <input type="text" id="question" class="question-input" placeholder="Ask a question about the data..." required>
                            <button type="submit" class="question-submit">
                                <span class="submit-text">Ask</span>
                                <i class="fas fa-paper-plane submit-icon"></i>
                            </button>
                        </form>
                        <div class="answer-container">
                            <div id="answer-box" class="answer-content">
                                <div class="answer-placeholder">Your answers will appear here. Try asking about creator and sponsor relationships, industry trends, or top collaborations.</div>
                            </div>
                            <div class="answer-loading" style="display: none;">
                                <div class="typing-indicator">
                                    <div class="typing-dot"></div>
                                    <div class="typing-dot"></div>
                                    <div class="typing-dot"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tooltip -->
<div id="graph-tooltip"></div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/three@0.149.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/3d-force-graph@1.77.0/dist/3d-force-graph.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/2d-force-graph@1.7.0/dist/2d-force-graph.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>

<script>
// Global state
const state = {
    theme: 'light',
    visualizationType: '3d',
    nodeSize: 'default',
    linkStrength: 'default',
    animationSpeed: 'default',
    graphInstances: {},
    graphData: {},
    stats: {
        totalCreators: 0,
        totalSponsors: 0,
        topCollaboration: {
            names: '',
            count: 0
        }
    }
};

// Utility: find node(s) with max incoming links (collaborations)
function getMaxTargetNodes(links) {
    const countMap = {};
    links.forEach(link => {
        countMap[link.target] = (countMap[link.target] || 0) + 1;
    });
    let maxCount = 0;
    let maxNodes = [];
    for (const [key, count] of Object.entries(countMap)) {
        if (count > maxCount) {
            maxCount = count;
            maxNodes = [key];
        } else if (count === maxCount) {
            maxNodes.push(key);
        }
    }
    return { maxNodes, maxCount };
}

// Count unique creators and sponsors
function countEntities(nodes) {
    let creators = 0;
    let sponsors = 0;
    
    nodes.forEach(node => {
        if (node.type === 'creator' || node.type === 'creator_industry') {
            creators++;
        } else if (node.type === 'sponsor' || node.type === 'sponsor_industry') {
            sponsors++;
        }
    });
    
    return { creators, sponsors };
}

// Update stats display
function updateStats(graphId, data) {
    // Store data for reference
    state.graphData[graphId] = data;
    
    if (graphId === 'graph1') {
        const { maxNodes, maxCount } = getMaxTargetNodes(data.links);
        const { creators, sponsors } = countEntities(data.nodes);
        
        // Update stats
        state.stats.totalCreators = creators;
        state.stats.totalSponsors = sponsors;
        
        // Find the names of the top collaboration
        if (maxNodes.length > 0) {
            const topSponsorId = maxNodes[0];
            const topSponsor = data.nodes.find(node => node.id === topSponsorId);
            
            if (topSponsor) {
                state.stats.topCollaboration.names = topSponsor.name;
                state.stats.topCollaboration.count = maxCount;
            }
        }
        
        // Update the UI
        document.getElementById('total-creators').textContent = creators;
        document.getElementById('total-sponsors').textContent = sponsors;
        document.getElementById('top-collaboration-count').textContent = maxCount;
        document.getElementById('top-collaboration-names').textContent = state.stats.topCollaboration.names;
        
        // Random trend percentages for demo purposes
        document.getElementById('creators-trend').textContent = Math.floor(Math.random() * 15) + 5;
        document.getElementById('sponsors-trend').textContent = Math.floor(Math.random() * 15) + 5;
    }
}

// Simple tooltip content
function generateTooltipContent(node) {
    return `<b>Name:</b> ${node.name || node.id}<br>` +
           `<b>Type:</b> ${node.type}<br>` +
           `<b>ID:</b> ${node.id}`;
}

// Render 3D Graph with dark theme
function render3DGraph(containerId, apiUrl, nodeTypeColors) {
    const container = document.getElementById(containerId);
    container.classList.add('loading');
    
    fetch(apiUrl)
        .then(res => res.json())
        .then(data => {
            const { maxNodes } = getMaxTargetNodes(data.links);
            
            // Process nodes
            const nodes = (data.nodes || []).map(node => {
                let color = nodeTypeColors[node.type] || "#888";
                if (maxNodes.includes(node.id)) color = "#ffb300";
                return {
                    ...node,
                    color,
                    val: maxNodes.includes(node.id) ? 8 : 5
                };
            });
            
            // Handle case where nodes aren't explicitly defined
            if (!nodes.length && data.links) {
                const nodeSet = new Set();
                data.links.forEach(l => { 
                    nodeSet.add(typeof l.source === 'object' ? l.source.id : l.source); 
                    nodeSet.add(typeof l.target === 'object' ? l.target.id : l.target); 
                });
                
                nodeSet.forEach(id => {
                    let type = id.split('_')[0];
                    let color = nodeTypeColors[type] || "#888";
                    if (maxNodes.includes(id)) color = "#ffb300";
                    nodes.push({ 
                        id, 
                        name: id.substring(id.indexOf('_')+1), 
                        type, 
                        color, 
                        val: maxNodes.includes(id) ? 8 : 5 
                    });
                });
            }
            
            // Process links
            const links = data.links.map(l => ({
                source: l.source,
                target: l.target
            }));
            
            // Store processed data
            const graphData = { nodes, links };
            
            // Update stats
            updateStats(containerId, { nodes, links });
            
            // Clear container
            container.innerHTML = "";
            
            // Tooltip setup
            const tooltip = document.getElementById('graph-tooltip');
            
            // Create graph instance with dark theme
            const Graph = ForceGraph3D({
                extraRenderers: [new THREE.WebGLRenderer({ 
                    antialias: true,
                    alpha: true
                })]
            })(container)
                .graphData(graphData)
                .nodeAutoColorBy('type')
                .nodeColor(node => node.color)
                .nodeVal(node => node.val)
                .nodeLabel(node => node.name || node.id)
                .linkOpacity(0.5)
                .linkWidth(1.5)
                .linkDirectionalParticles(0)
                .backgroundColor('#000000') // Dark background
                .showNavInfo(false)
                .width(container.offsetWidth)
                .height(container.offsetHeight)
                .onNodeHover(node => {
                    if (node) {
                        tooltip.style.display = 'block';
                        tooltip.innerHTML = generateTooltipContent(node);
                    } else {
                        tooltip.style.display = 'none';
                    }
                })
                .onNodeClick(node => {
                    // Focus on node with animation
                    const distance = 40;
                    const distRatio = 1 + distance/Math.hypot(node.x, node.y, node.z);
                    
                    Graph.cameraPosition(
                        { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio },
                        node,
                        1000
                    );
                });

            // Move tooltip with mouse
            container.addEventListener('mousemove', function(e) {
                tooltip.style.left = (e.clientX + 15) + 'px';
                tooltip.style.top = (e.clientY + 15) + 'px';
            });
            
            // Store graph instance for later reference
            state.graphInstances[containerId] = Graph;
            
            // Remove loading state
            container.classList.remove('loading');
            
            // Add cool animation on load
            setTimeout(() => {
                Graph.zoomToFit(400);
            }, 500);
        })
        .catch(error => {
            console.error('Error loading graph data:', error);
            container.classList.remove('loading');
            container.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: 100%; flex-direction: column;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i>
                    <p style="text-align: center;">Error loading graph data.<br>Please try refreshing the page.</p>
                </div>
            `;
        });
}

// Render graph based on visualization type
function renderGraph(containerId, apiUrl, nodeTypeColors) {
    if (state.visualizationType === '3d') {
        render3DGraph(containerId, apiUrl, nodeTypeColors);
    } else {
        render2DGraph(containerId, apiUrl, nodeTypeColors);
    }
}

// Refresh all graphs
function refreshAllGraphs() {
    renderGraph(
        'graph1',
        '/api/creator_sponsor_graph',
        { creator: '#023020', sponsor: '#add8e6' }
    );
    
    renderGraph(
        'graph2',
        '/api/industry_graph',
        { creator_industry: '#00008B', sponsor_industry: '#dc143c' }
    );
}

// Initialize graphs
refreshAllGraphs();

// Control panel event listeners
document.getElementById('visualization-type').addEventListener('change', function() {
    state.visualizationType = this.value;
    refreshAllGraphs();
});

document.getElementById('node-size').addEventListener('change', function() {
    state.nodeSize = this.value;
    refreshAllGraphs();
});

document.getElementById('link-strength').addEventListener('change', function() {
    state.linkStrength = this.value;
    refreshAllGraphs();
});

document.getElementById('animation-speed').addEventListener('change', function() {
    state.animationSpeed = this.value;
    refreshAllGraphs();
});

// Refresh graph buttons
document.querySelectorAll('.refresh-graph').forEach(button => {
    button.addEventListener('click', function() {
        const graphId = this.getAttribute('data-graph');
        const container = document.getElementById(graphId);
        
        // Add loading state
        container.classList.add('loading');
        
        // Add rotation animation to button
        this.classList.add('rotating');
        
        // Refresh the specific graph
        if (graphId === 'graph1') {
            renderGraph(
                'graph1',
                '/api/creator_sponsor_graph',
                { creator: '#023020', sponsor: '#add8e6' }
            );
        } else if (graphId === 'graph2') {
            renderGraph(
                'graph2',
                '/api/industry_graph',
                { creator_industry: '#00008B', sponsor_industry: '#dc143c' }
            );
        }
        
        // Remove rotation after a delay
        setTimeout(() => {
            this.classList.remove('rotating');
        }, 1000);
    });
});

// Fullscreen graph buttons
document.querySelectorAll('.fullscreen-graph').forEach(button => {
    button.addEventListener('click', function() {
        const graphId = this.getAttribute('data-graph');
        const container = document.getElementById(graphId);
        
        if (!document.fullscreenElement) {
            container.requestFullscreen().catch(err => {
                console.error(`Error attempting to enable fullscreen: ${err.message}`);
            });
            this.innerHTML = '<i class="fas fa-compress"></i>';
        } else {
            document.exitFullscreen();
            this.innerHTML = '<i class="fas fa-expand"></i>';
        }
    });
});

// Handle fullscreen change
document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement) {
        document.querySelectorAll('.fullscreen-graph').forEach(button => {
            button.innerHTML = '<i class="fas fa-expand"></i>';
        });
    }
});

// Enhanced question form submission
document.getElementById('question-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const questionInput = document.getElementById('question');
    const question = questionInput.value.trim();
    const answerBox = document.getElementById('answer-box');
    const answerLoading = document.querySelector('.answer-loading');
    const submitButton = this.querySelector('.question-submit');
    
    if (!question) return;
    
    // Show loading state
    answerLoading.style.display = 'flex';
    answerBox.innerHTML = '';
    submitButton.classList.add('loading');
    submitButton.querySelector('.submit-text').textContent = 'Asking';
    
    try {
        const response = await fetch('/ask_question', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question })
        });
        
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        
        const data = await response.json();
        
        // Simulate typing effect
        typeWriter(answerBox, data.answer, 0, 20);
        
        // Clear input
        questionInput.value = '';
    } catch (error) {
        console.error('Error asking question:', error);
        answerBox.innerHTML = `
            <div style="color: #dc3545;">
                <i class="fas fa-exclamation-circle"></i> 
                Sorry, there was an error processing your question. Please try again.
            </div>
        `;
    } finally {
        // Hide loading state
        answerLoading.style.display = 'none';
        submitButton.classList.remove('loading');
        submitButton.querySelector('.submit-text').textContent = 'Ask';
    }
});

// Clear chat button
document.getElementById('clear-chat').addEventListener('click', function() {
    document.getElementById('answer-box').innerHTML = `
        <div class="answer-placeholder">Your answers will appear here. Try asking about creator and sponsor relationships, industry trends, or top collaborations.</div>
    `;
    document.getElementById('question').value = '';
});

// Typing effect function
function typeWriter(element, text, i, speed) {
    if (i < text.length) {
        element.innerHTML += text.charAt(i);
        i++;
        setTimeout(() => typeWriter(element, text, i, speed), speed);
    }
}

// Add CSS for button rotation
const style = document.createElement('style');
style.textContent = `
    .rotating {
        animation: rotate 1s linear;
    }
    
    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);

// Window resize handler
window.addEventListener('resize', () => {
    Object.values(state.graphInstances).forEach(graph => {
        if (graph && typeof graph.width === 'function') {
            const container = graph.graphData().container;
            graph.width(container ? container.offsetWidth : window.innerWidth);
            graph.height(container ? container.offsetHeight : window.innerHeight);
        }
    });
});
</script>

{% endblock %}
